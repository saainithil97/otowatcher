{% extends "base.html" %}

{% block title %}Aquarium Timelapse - Home{% endblock %}

{% block content %}
<div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="sidebar w-64 flex-shrink-0 overflow-y-auto">
        <div class="p-6">
            <h1 class="text-xl font-semibold mb-8">Aquarium Timelapse</h1>
            
            <nav class="space-y-1">
                <div class="nav-item active" data-section="latest">Latest Image</div>
                <div class="nav-item" data-section="live">Live Stream</div>
                <div class="nav-item" data-section="gallery">Gallery</div>
                <div class="nav-item" data-section="settings">Settings</div>
                <div class="nav-item" data-section="services">Services</div>
            </nav>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
        <div class="max-w-6xl mx-auto p-8">
            <!-- Notification Container -->
            <div id="notification-container" class="fixed top-4 right-4 max-w-md z-40"></div>

            <!-- Latest Image Section -->
            <section id="latest-section" class="section active">
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold mb-2">Latest Capture</h2>
                    <p class="text-secondary">Real-time view of your aquarium</p>
                </div>
                
                <!-- Stats -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="card p-4 rounded-lg">
                        <div class="text-secondary text-sm mb-1">Total Images</div>
                        <div class="text-2xl font-semibold">{{ stats.total_images }}</div>
                    </div>
                    <div class="card p-4 rounded-lg">
                        <div class="text-secondary text-sm mb-1">Today</div>
                        <div class="text-2xl font-semibold">{{ stats.today_images }}</div>
                    </div>
                    <div class="card p-4 rounded-lg">
                        <div class="text-secondary text-sm mb-1">Storage</div>
                        <div class="text-2xl font-semibold">{{ stats.disk_usage_gb }} GB</div>
                    </div>
                    <div class="card p-4 rounded-lg">
                        <div class="text-secondary text-sm mb-1">Last Capture</div>
                        {% if stats.latest_time %}
                        <div class="text-2xl font-semibold">{{ stats.latest_time.strftime('%H:%M') }}</div>
                        <div class="text-secondary text-xs">{{ stats.latest_time.strftime('%b %d') }}</div>
                        {% else %}
                        <div class="text-2xl font-semibold">--:--</div>
                        {% endif %}
                    </div>
                </div>
                
                {% if has_image %}
                <!-- Image -->
                <div class="card p-4 rounded-lg mb-4">
                    <img id="latest-image" 
                         src="/latest.jpg?t={{ stats.latest_time.timestamp() if stats.latest_time else 0 }}" 
                         alt="Latest aquarium photo"
                         class="w-full rounded-lg"
                         style="max-height: 70vh; object-fit: contain;">
                </div>
                
                <!-- Controls -->
                <div class="flex gap-3">
                    <button onclick="latestImage.refresh()" class="btn px-4 py-2 rounded-lg">Refresh</button>
                    <button id="auto-refresh-btn" onclick="latestImage.toggleAutoRefresh()" class="btn px-4 py-2 rounded-lg">
                        <span id="auto-refresh-text">Auto-Refresh (30s)</span>
                    </button>
                    <button onclick="latestImage.download()" class="btn px-4 py-2 rounded-lg">Download</button>
                </div>
                {% else %}
                <div class="card p-12 rounded-lg text-center">
                    <div class="text-secondary text-sm">No images captured yet</div>
                </div>
                {% endif %}
            </section>
            
            <!-- Live Stream Section -->
            <section id="live-section" class="section">
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold mb-2">Live Stream</h2>
                    <p class="text-secondary">Real-time camera preview</p>
                </div>
                
                <div class="card p-6 rounded-lg mb-4">
                    <div class="mb-4 flex items-center justify-between">
                        <div>
                            <div class="font-medium mb-1">Camera Stream</div>
                            <div class="text-secondary text-sm">Preview what the camera sees (1280x960)</div>
                        </div>
                        <div id="stream-status-pill" class="status-pill status-inactive">
                            <span class="status-dot"></span>
                            <span>Inactive</span>
                        </div>
                    </div>
                    
                    <div id="stream-container" class="mb-4">
                        <div id="stream-placeholder" class="bg-black rounded-lg flex items-center justify-center" style="height: 480px;">
                            <div class="text-secondary">Stream not started</div>
                        </div>
                        <img id="stream-feed" src="" alt="Live stream" class="w-full rounded-lg hidden" style="max-height: 70vh; object-fit: contain;">
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="start-stream-btn" onclick="StreamComponent.start()" class="btn-primary px-4 py-2 rounded-lg">Start Stream</button>
                        <button id="stop-stream-btn" onclick="StreamComponent.stop()" class="btn px-4 py-2 rounded-lg" style="display: none;">Stop Stream</button>
                    </div>
                    
                    <div class="mt-4 p-3 rounded-lg bg-tertiary text-sm">
                        <div class="text-secondary mb-2">⚠️ <strong>Important:</strong> The camera can only be used by one process at a time.</div>
                        <div class="text-secondary">Before starting the stream:</div>
                        <div class="text-secondary ml-4 mt-1">
                            1. Go to the Services tab<br>
                            2. Click "Stop" on Capture Service<br>
                            3. Return here and click "Start Stream"
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Gallery Section -->
            <section id="gallery-section" class="section">
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold mb-2">Gallery</h2>
                    <p class="text-secondary">Browse recent captures</p>
                </div>
                <div id="gallery-grid" class="grid grid-cols-3 gap-4">
                    <div class="text-secondary">Loading...</div>
                </div>
            </section>
            
            <!-- Settings Section -->
            <section id="settings-section" class="section">
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold mb-2">Settings</h2>
                    <p class="text-secondary">Configure capture parameters</p>
                </div>
                
                <div class="card p-6 rounded-lg">
                    <div id="config-editor">
                        <div class="text-secondary mb-3">Edit configuration (JSON format)</div>
                        <textarea id="config-json" 
                                  class="w-full h-96 p-4 rounded-lg font-mono text-sm"
                                  style="resize: vertical;">Loading...</textarea>
                        <div class="flex gap-3 mt-4">
                            <button onclick="ConfigComponent.save()" class="btn-primary px-4 py-2 rounded-lg">Save Configuration</button>
                            <button onclick="ConfigComponent.reload()" class="btn px-4 py-2 rounded-lg">Reload</button>
                        </div>
                        <div id="config-message" class="mt-3 text-sm"></div>
                    </div>
                </div>
            </section>
            
            <!-- Services Section -->
            <section id="services-section" class="section">
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold mb-2">Services</h2>
                    <p class="text-secondary">Control system services</p>
                </div>
                
                <div class="space-y-4">
                    <!-- Capture Service -->
                    <div class="card p-6 rounded-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <div class="font-semibold mb-1">Capture Service</div>
                                <div class="text-secondary text-sm">Main timelapse capture process</div>
                            </div>
                            <div id="capture-status" class="status-pill status-inactive">
                                <span class="status-dot"></span>
                                <span>Unknown</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="ServiceComponent.control('start', 'timelapse.service')" class="btn px-3 py-1.5 rounded text-sm">Start</button>
                            <button onclick="ServiceComponent.control('stop', 'timelapse.service')" class="btn px-3 py-1.5 rounded text-sm">Stop</button>
                            <button onclick="ServiceComponent.control('restart', 'timelapse.service')" class="btn px-3 py-1.5 rounded text-sm">Restart</button>
                        </div>
                    </div>
                    
                    <!-- Sync Timer -->
                    <div class="card p-6 rounded-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <div class="font-semibold mb-1">Sync Timer</div>
                                <div class="text-secondary text-sm">Google Drive sync (every 6 hours)</div>
                            </div>
                            <div id="sync-status" class="status-pill status-inactive">
                                <span class="status-dot"></span>
                                <span>Unknown</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="ServiceComponent.control('start', 'timelapse-sync.timer')" class="btn px-3 py-1.5 rounded text-sm">Start</button>
                            <button onclick="ServiceComponent.control('stop', 'timelapse-sync.timer')" class="btn px-3 py-1.5 rounded text-sm">Stop</button>
                        </div>
                    </div>
                    
                    <!-- Cleanup Timer -->
                    <div class="card p-6 rounded-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <div class="font-semibold mb-1">Cleanup Timer</div>
                                <div class="text-secondary text-sm">Local cleanup (daily at 3am)</div>
                            </div>
                            <div id="cleanup-status" class="status-pill status-inactive">
                                <span class="status-dot"></span>
                                <span>Unknown</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="ServiceComponent.control('start', 'timelapse-cleanup.timer')" class="btn px-3 py-1.5 rounded text-sm">Start</button>
                            <button onclick="ServiceComponent.control('stop', 'timelapse-cleanup.timer')" class="btn px-3 py-1.5 rounded text-sm">Stop</button>
                        </div>
                    </div>
                    
                    <!-- Health Status -->
                    <div class="card p-6 rounded-lg">
                        <div class="font-semibold mb-4">System Health</div>
                        <div id="health-info" class="text-secondary text-sm">Loading...</div>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>
{% endblock %}
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold mb-2">Latest Capture</h2>
                        <p style="color: var(--text-secondary)">Real-time view of your aquarium</p>
                    </div>
                    
                    <!-- Stats -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="card p-4 rounded-lg">
                            <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">Total Images</div>
                            <div class="text-2xl font-semibold">{{ stats.total_images }}</div>
                        </div>
                        <div class="card p-4 rounded-lg">
                            <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">Today</div>
                            <div class="text-2xl font-semibold">{{ stats.today_images }}</div>
                        </div>
                        <div class="card p-4 rounded-lg">
                            <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">Storage</div>
                            <div class="text-2xl font-semibold">{{ stats.disk_usage_gb }} GB</div>
                        </div>
                        <div class="card p-4 rounded-lg">
                            <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">Last Capture</div>
                            {% if stats.latest_time %}
                            <div class="text-2xl font-semibold">{{ stats.latest_time.strftime('%H:%M') }}</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">{{ stats.latest_time.strftime('%b %d') }}</div>
                            {% else %}
                            <div class="text-2xl font-semibold">--:--</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if has_image %}
                    <!-- Image -->
                    <div class="card p-4 rounded-lg mb-4">
                        <img id="latest-image" 
                             src="/latest.jpg?t={{ stats.latest_time.timestamp() if stats.latest_time else 0 }}" 
                             alt="Latest aquarium photo"
                             class="w-full rounded-lg"
                             style="max-height: 70vh; object-fit: contain;">
                    </div>
                    
                    <!-- Controls -->
                    <div class="flex gap-3">
                        <button onclick="refreshImage()" class="btn px-4 py-2 rounded-lg">Refresh</button>
                        <button id="auto-refresh-btn" onclick="toggleAutoRefresh()" class="btn px-4 py-2 rounded-lg">
                            <span id="auto-refresh-text">Auto-Refresh (30s)</span>
                        </button>
                        <button onclick="window.open('/latest.jpg', '_blank')" class="btn px-4 py-2 rounded-lg">Download</button>
                    </div>
                    {% else %}
                    <div class="card p-12 rounded-lg text-center">
                        <div style="color: var(--text-secondary); font-size: 14px;">No images captured yet</div>
                    </div>
                    {% endif %}
                </section>
                
                <!-- Live Stream Section -->
                <section id="live-section" class="section">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold mb-2">Live Stream</h2>
                        <p style="color: var(--text-secondary)">Real-time camera preview</p>
                    </div>
                    
                    <div class="card p-6 rounded-lg mb-4">
                        <div class="mb-4 flex items-center justify-between">
                            <div>
                                <div class="font-medium mb-1">Camera Stream</div>
                                <div style="color: var(--text-secondary); font-size: 13px;">Preview what the camera sees (1280x960)</div>
                            </div>
                            <div id="stream-status-pill" class="status-pill status-inactive">
                                <span class="status-dot"></span>
                                <span>Inactive</span>
                            </div>
                        </div>
                        
                        <div id="stream-container" class="mb-4">
                            <div id="stream-placeholder" class="bg-black rounded-lg flex items-center justify-center" style="height: 480px;">
                                <div style="color: var(--text-secondary)">Stream not started</div>
                            </div>
                            <img id="stream-feed" src="" alt="Live stream" class="w-full rounded-lg hidden" style="max-height: 70vh; object-fit: contain;">
                        </div>
                        
                        <div class="flex gap-3">
                            <button id="start-stream-btn" onclick="startStream()" class="btn-primary px-4 py-2 rounded-lg">Start Stream</button>
                            <button id="stop-stream-btn" onclick="stopStream()" class="btn px-4 py-2 rounded-lg" style="display: none;">Stop Stream</button>
                        </div>
                        
                        <div class="mt-4 p-3 rounded-lg" style="background: var(--bg-tertiary); font-size: 13px;">
                            <div style="color: var(--text-secondary); margin-bottom: 8px;">⚠️ <strong>Important:</strong> The camera can only be used by one process at a time.</div>
                            <div style="color: var(--text-secondary);">Before starting the stream:</div>
                            <div style="color: var(--text-secondary); margin-left: 16px; margin-top: 4px;">
                                1. Go to the Services tab<br>
                                2. Click "Stop" on Capture Service<br>
                                3. Return here and click "Start Stream"
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Gallery Section -->
                <section id="gallery-section" class="section">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold mb-2">Gallery</h2>
                        <p style="color: var(--text-secondary)">Browse recent captures</p>
                    </div>
                    <div id="gallery-grid" class="grid grid-cols-3 gap-4">
                        <div style="color: var(--text-secondary)">Loading...</div>
                    </div>
                </section>
                
                <!-- Settings Section -->
                <section id="settings-section" class="section">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold mb-2">Settings</h2>
                        <p style="color: var(--text-secondary)">Configure capture parameters</p>
                    </div>
                    
                    <div class="card p-6 rounded-lg">
                        <div id="config-editor">
                            <div style="color: var(--text-secondary); margin-bottom: 12px;">Edit configuration (JSON format)</div>
                            <textarea id="config-json" 
                                      class="w-full h-96 p-4 rounded-lg font-mono text-sm"
                                      style="resize: vertical;">Loading...</textarea>
                            <div class="flex gap-3 mt-4">
                                <button onclick="saveConfig()" class="btn-primary px-4 py-2 rounded-lg">Save Configuration</button>
                                <button onclick="loadConfig()" class="btn px-4 py-2 rounded-lg">Reload</button>
                            </div>
                            <div id="config-message" class="mt-3" style="font-size: 14px;"></div>
                        </div>
                    </div>
                </section>
                
                <!-- Services Section -->
                <section id="services-section" class="section">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold mb-2">Services</h2>
                        <p style="color: var(--text-secondary)">Control system services</p>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Capture Service -->
                        <div class="card p-6 rounded-lg">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="font-semibold mb-1">Capture Service</div>
                                    <div style="color: var(--text-secondary); font-size: 13px;">Main timelapse capture process</div>
                                </div>
                                <div id="capture-status" class="status-pill status-inactive">
                                    <span class="status-dot"></span>
                                    <span>Unknown</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="controlService('start', 'timelapse.service')" class="btn px-3 py-1.5 rounded text-sm">Start</button>
                                <button onclick="controlService('stop', 'timelapse.service')" class="btn px-3 py-1.5 rounded text-sm">Stop</button>
                                <button onclick="controlService('restart', 'timelapse.service')" class="btn px-3 py-1.5 rounded text-sm">Restart</button>
                            </div>
                        </div>
                        
                        <!-- Sync Timer -->
                        <div class="card p-6 rounded-lg">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="font-semibold mb-1">Sync Timer</div>
                                    <div style="color: var(--text-secondary); font-size: 13px;">Google Drive sync (every 6 hours)</div>
                                </div>
                                <div id="sync-status" class="status-pill status-inactive">
                                    <span class="status-dot"></span>
                                    <span>Unknown</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="controlService('start', 'timelapse-sync.timer')" class="btn px-3 py-1.5 rounded text-sm">Start</button>
                                <button onclick="controlService('stop', 'timelapse-sync.timer')" class="btn px-3 py-1.5 rounded text-sm">Stop</button>
                            </div>
                        </div>
                        
                        <!-- Cleanup Timer -->
                        <div class="card p-6 rounded-lg">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="font-semibold mb-1">Cleanup Timer</div>
                                    <div style="color: var(--text-secondary); font-size: 13px;">Local cleanup (daily at 3am)</div>
                                </div>
                                <div id="cleanup-status" class="status-pill status-inactive">
                                    <span class="status-dot"></span>
                                    <span>Unknown</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="controlService('start', 'timelapse-cleanup.timer')" class="btn px-3 py-1.5 rounded text-sm">Start</button>
                                <button onclick="controlService('stop', 'timelapse-cleanup.timer')" class="btn px-3 py-1.5 rounded text-sm">Stop</button>
                            </div>
                        </div>
                        
                        <!-- Health Status -->
                        <div class="card p-6 rounded-lg">
                            <div class="font-semibold mb-4">System Health</div>
                            <div id="health-info" style="color: var(--text-secondary); font-size: 14px;">Loading...</div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Keyboard shortcuts
    KeyboardShortcuts.register('r', () => latestImage.refresh());
    KeyboardShortcuts.register(' ', () => latestImage.toggleAutoRefresh());
    
    // Load services on page load
    window.addEventListener('load', () => {
        ServiceComponent.loadStatus();
    });
    
    // Helper functions for section loading
    function loadLatest() {
        ServiceComponent.loadStatus();
    }
    
    function loadLive() {
        StreamComponent.checkStatus();
    }
    
    function loadGallery() {
        GalleryComponent.load();
    }
    
    function loadSettings() {
        ConfigComponent.load();
    }
    
    function loadServices() {
        ServiceComponent.loadStatus();
    }
</script>
{% endblock %}
